@(username: String, msg: models.PrivateMessageWithUsers)(implicit request: RequestHeader, flash: Flash)

@user.userLayout("Mensaje", username) {
    <div style="max-width: 700px; width: 100%;">
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem;">
            <a href="@routes.UserPublicationController.inbox("received")" class="u-btn u-btn-secondary u-btn-sm" style="text-decoration:none;">&larr; Mensajes</a>
            <h2 style="font-size: 1.125rem; font-weight: 700; color: #1a202c;">Mensaje</h2>
        </div>

        <div class="u-card" style="border-left: 3px solid #6b8caa;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #f1f5f9; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 700; color: #64748b; flex-shrink: 0;">
                        @msg.senderUsername.substring(0, 1).toUpperCase
                    </div>
                    <div>
                        <div style="font-weight: 700; font-size: 0.875rem; color: #1a202c;">
                            <a href="@routes.UserPublicationController.publicProfile(msg.senderUsername)" style="color: inherit; text-decoration: none;">
                                @msg.senderFullName
                            </a>
                        </div>
                        <div style="font-size: 0.75rem; color: #94a3b8;">
                            @@@msg.senderUsername &rarr;
                            <a href="@routes.UserPublicationController.publicProfile(msg.receiverUsername)" style="color: #6b8caa; text-decoration: none;">
                                @msg.receiverFullName
                            </a>
                        </div>
                    </div>
                </div>
                <span style="font-size: 0.75rem; color: #94a3b8;">
                    @msg.message.createdAt.toString.substring(0, 16).replace("T", " ")
                </span>
            </div>

            <!-- Subject -->
            <h3 style="font-size: 1.125rem; font-weight: 700; color: #1a202c; margin-bottom: 0.75rem; word-break: break-word;">
                @msg.message.subject
            </h3>

            <!-- Publication badge -->
            @if(msg.publicationTitle.isDefined) {
                <div style="display: inline-flex; align-items: center; gap: 0.375rem; background: #eef4fa; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; color: #6b8caa; margin-bottom: 1rem;">
                    <span>Sobre:</span>
                    <strong>@msg.publicationTitle.get</strong>
                </div>
            }

            <!-- Content -->
            <div style="font-size: 0.9375rem; line-height: 1.75; color: #374151; word-break: break-word; margin-top: 0.5rem;">
                @Html(msg.message.content.replaceAll("\n", "<br/>"))
            </div>
        </div>

        <!-- Reply -->
        @if(msg.message.senderId != msg.message.receiverId) {
            @defining(if(msg.message.receiverId.toString == request.session.get("userId").getOrElse("")) msg.senderUsername else msg.receiverUsername) { replyToUser =>
                @if(request.session.get("userId").map(_.toLong).contains(msg.message.receiverId)) {
                    <div class="u-card" style="margin-top: 1rem;">
                        <h4 style="font-size: 0.875rem; font-weight: 700; color: #1a202c; margin-bottom: 0.75rem;">Responder</h4>
                        <form method="POST" action="@routes.UserPublicationController.sendDirectMessage()">
                            @helper.CSRF.formField
                            <input type="hidden" name="receiverUsername" value="@msg.senderUsername">
                            <div style="margin-bottom: 0.75rem;">
                                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">Asunto</label>
                                <input type="text" name="subject" value="Re: @msg.message.subject" required
                                    style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8125rem; font-family: inherit; color: #1a202c; box-sizing: border-box; transition: border-color 0.15s;"
                                    onfocus="this.style.borderColor='#6b8caa'" onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">Mensaje</label>
                                <textarea name="content" rows="4" required minlength="5" maxlength="5000" placeholder="Escribe tu respuesta..."
                                    style="width: 100%; padding: 0.625rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8125rem; font-family: inherit; color: #1a202c; resize: vertical; box-sizing: border-box; transition: border-color 0.15s;"
                                    onfocus="this.style.borderColor='#6b8caa'" onblur="this.style.borderColor='#e2e8f0'"></textarea>
                            </div>
                            <div style="display: flex; justify-content: flex-end;">
                                <button type="submit" class="u-btn u-btn-primary u-btn-sm">Enviar respuesta</button>
                            </div>
                        </form>
                    </div>
                }
            }
        }
    </div>
}

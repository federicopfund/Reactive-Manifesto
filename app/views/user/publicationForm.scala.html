@(form: Form[controllers.PublicationFormData], publication: Option[models.Publication], username: String)(implicit request: RequestHeader, flash: Flash)

@main(if(publication.isDefined) "Editar PublicaciÃ³n" else "Nueva PublicaciÃ³n") {

    <!-- FULLSCREEN EDITOR OVERLAY -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <div class="fullscreen-header">
            <h3>ğŸ“ Editor de Contenido</h3>
            <div style="display:flex;gap:0.5rem;align-items:center;">
                <button type="button" class="md-toolbar-toggle" id="fsPreviewToggle" onclick="toggleFullscreenPreview()">ğŸ‘ Preview</button>
                <button type="button" class="fullscreen-close" onclick="closeFullscreen()">âœ• Cerrar <span class="kbd">Esc</span></button>
            </div>
        </div>
        <div class="fullscreen-body">
            <textarea id="fsContent" placeholder="Escribe tu contenido aquÃ­..."></textarea>
            <div class="preview-pane" id="fsPreview"></div>
        </div>
        <div class="fullscreen-stats">
            <span class="stat-item">ğŸ“ <span class="stat-value" id="fsWordCount">0</span> palabras</span>
            <span class="stat-item">â± <span class="stat-value" id="fsReadTime">0</span> min lectura</span>
            <span class="stat-item">ğŸ“ <span class="stat-value" id="fsCharCount">0</span> caracteres</span>
        </div>
    </div>

    <div class="publication-container">
        <div class="publication-header">
            <h1>@if(publication.isDefined) { âœï¸ Editar PublicaciÃ³n } else { âœ¨ Nueva PublicaciÃ³n }</h1>
            <a href="@routes.UserPublicationController.dashboard()">â† Volver al Dashboard</a>
        </div>

        <div class="form-wrapper">
            <!-- PROGRESS BAR -->
            <div class="form-progress">
                <span class="progress-label">Progreso</span>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progressFill"></div>
                </div>
                <span class="progress-text" id="progressText">0%</span>
            </div>

            <!-- AUTOSAVE INDICATOR -->
            <div class="autosave-indicator" id="autosaveIndicator">
                <span class="autosave-dot"></span>
                <span id="autosaveText">Auto-guardado activo</span>
                <div class="autosave-actions">
                    <button type="button" class="autosave-btn restore" id="restoreDraftBtn" style="display:none;" onclick="restoreDraft()">ğŸ”„ Restaurar borrador</button>
                    <button type="button" class="autosave-btn" onclick="clearDraft()">ğŸ—‘ Limpiar borrador</button>
                </div>
            </div>

            <div class="form-header">
                <h2>@if(publication.isDefined) { Editar tu PublicaciÃ³n } else { Comparte tu Conocimiento }</h2>
                <p>@if(publication.isDefined) { Actualiza el contenido de tu publicaciÃ³n } else { Crea contenido de calidad para nuestra comunidad }</p>
            </div>

            <div class="form-content">
                @if(form.hasGlobalErrors) {
                    <div class="error">
                        <strong>Errores en el formulario:</strong>
                        <ul class="error-list">
                            @for(err <- form.globalErrors) {
                                <li>@err.message</li>
                            }
                        </ul>
                    </div>
                }

                @if(publication.isDefined) {
                    <div class="publication-info">
                        <div class="info-header">
                            <span>ğŸ“‹</span>
                            <h3>Estado de la PublicaciÃ³n</h3>
                        </div>
                        <div class="info-content">
                            <p>
                                <strong>Estado:</strong>
                                <span class="status-badge @publication.get.status.toLowerCase">
                                    @{
                                        publication.get.status match {
                                            case "draft" => "ğŸ“ Borrador"
                                            case "pending" => "â³ Pendiente de RevisiÃ³n"
                                            case "approved" => "âœ… Aprobada"
                                            case "rejected" => "âŒ Rechazada"
                                            case _ => publication.get.status
                                        }
                                    }
                                </span>
                            </p>
                            <p><strong>Creada:</strong> @publication.get.createdAt.toString.substring(0, 10)</p>
                            <p><strong>Ãšltima actualizaciÃ³n:</strong> @publication.get.updatedAt.toString.substring(0, 10)</p>
                        </div>
                    </div>
                }

                <form method="POST" action="@if(publication.isDefined) { @routes.UserPublicationController.updatePublication(publication.get.id.get) } else { @routes.UserPublicationController.createPublication() }" class="publication-form">
                    @helper.CSRF.formField

                    <!-- SECCIÃ“N: INFORMACIÃ“N BÃSICA -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <span>ğŸ“</span>
                            <span>InformaciÃ³n BÃ¡sica</span>
                        </div>

                        <div class="form-group">
                            <label for="title">
                                TÃ­tulo
                                <span class="required">*</span>
                                <span class="char-count"><span id="titleCount">0</span>/200</span>
                            </label>
                            <input
                                type="text"
                                id="title"
                                name="title"
                                value="@form("title").value.getOrElse("")"
                                placeholder="Ej: IntroducciÃ³n a Akka Actors en Scala"
                                required
                                minlength="5"
                                maxlength="200"
                                autofocus
                                @if(form("title").hasErrors) { class="has-error" }
                            />
                            <div class="title-preview">
                                <div class="title-preview-label">Vista Previa:</div>
                                <div class="title-preview-text" id="titlePreview">Tu tÃ­tulo aparecerÃ¡ aquÃ­</div>
                            </div>
                            <div class="character-indicator" id="titleIndicator"></div>
                            <div class="help-text">
                                MÃ­nimo <strong>5 caracteres</strong>, mÃ¡ximo <strong>200</strong>.
                                SÃ© descriptivo y atractivo - este serÃ¡ el primer contacto del lector.
                            </div>
                            @if(form("title").hasErrors) {
                                <div class="field-error">@form("title").errors.map(_.message).mkString(", ")</div>
                            }
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="category">
                                    CategorÃ­a
                                    <span class="required">*</span>
                                </label>
                                <select id="category" name="category" required @if(form("category").hasErrors) { class="has-error" }>
                                    <option value="">ğŸ“‚ Selecciona una categorÃ­a</option>
                                    <option value="Scala" @if(form("category").value.contains("Scala")) { selected }>ğŸ¯ Scala</option>
                                    <option value="Akka" @if(form("category").value.contains("Akka")) { selected }>âš¡ Akka</option>
                                    <option value="Play Framework" @if(form("category").value.contains("Play Framework")) { selected }>ğŸ® Play Framework</option>
                                    <option value="Reactive Streams" @if(form("category").value.contains("Reactive Streams")) { selected }>ğŸŒŠ Reactive Streams</option>
                                    <option value="Arquitectura" @if(form("category").value.contains("Arquitectura")) { selected }>ğŸ—ï¸ Arquitectura</option>
                                    <option value="Patterns" @if(form("category").value.contains("Patterns")) { selected }>ğŸ§© Patterns</option>
                                    <option value="Testing" @if(form("category").value.contains("Testing")) { selected }>âœ… Testing</option>
                                    <option value="DevOps" @if(form("category").value.contains("DevOps")) { selected }>ğŸš€ DevOps</option>
                                </select>
                                <div class="help-text">Elige la categorÃ­a mÃ¡s representativa de tu contenido.</div>
                                @if(form("category").hasErrors) {
                                    <div class="field-error">@form("category").errors.map(_.message).mkString(", ")</div>
                                }
                            </div>

                            <div class="form-group">
                                <label for="tags">
                                    Etiquetas
                                    <span class="char-count" id="tagsLabel">(0)</span>
                                </label>
                                <input type="hidden" id="tags" name="tags" value="@form("tags").value.getOrElse("")" />
                                <div class="tags-container">
                                    <div class="tag-chips" id="tagChips" onclick="document.getElementById('tagInputInline').focus()">
                                        <input type="text" class="tag-input-inline" id="tagInputInline" placeholder="Escribe y presiona Enter..." autocomplete="off" />
                                    </div>
                                    <div class="tag-count-badge" id="tagCountBadge"></div>
                                </div>
                                <div class="help-text">
                                    Presiona <span class="kbd">Enter</span> o <span class="kbd">,</span> para agregar.
                                    Click en âœ• para eliminar. <strong>MÃ¡ximo 7 etiquetas</strong>
                                </div>
                                <div class="tag-suggestions-row" id="tagSuggestions">
                                    <span class="tag-suggestion" data-tag="scala" onclick="addTagFromSuggestion(this)">ğŸ¯ scala</span>
                                    <span class="tag-suggestion" data-tag="akka" onclick="addTagFromSuggestion(this)">âš¡ akka</span>
                                    <span class="tag-suggestion" data-tag="play-framework" onclick="addTagFromSuggestion(this)">ğŸ® play-framework</span>
                                    <span class="tag-suggestion" data-tag="reactive" onclick="addTagFromSuggestion(this)">ğŸŒŠ reactive</span>
                                    <span class="tag-suggestion" data-tag="arquitectura" onclick="addTagFromSuggestion(this)">ğŸ—ï¸ arquitectura</span>
                                    <span class="tag-suggestion" data-tag="patterns" onclick="addTagFromSuggestion(this)">ğŸ§© patterns</span>
                                    <span class="tag-suggestion" data-tag="testing" onclick="addTagFromSuggestion(this)">âœ… testing</span>
                                    <span class="tag-suggestion" data-tag="devops" onclick="addTagFromSuggestion(this)">ğŸš€ devops</span>
                                    <span class="tag-suggestion" data-tag="docker" onclick="addTagFromSuggestion(this)">ğŸ³ docker</span>
                                    <span class="tag-suggestion" data-tag="functional" onclick="addTagFromSuggestion(this)">Î» functional</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIÃ“N: DESCRIPCIÃ“N Y CONTENIDO -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <span>ğŸ“„</span>
                            <span>DescripciÃ³n y Contenido</span>
                        </div>

                        <div class="form-group">
                            <label for="excerpt">
                                Extracto / DescripciÃ³n
                                <span class="char-count"><span id="excerptCount">0</span>/500</span>
                            </label>
                            <textarea
                                id="excerpt"
                                name="excerpt"
                                rows="3"
                                maxlength="500"
                                placeholder="Breve resumen de tu publicaciÃ³n (lo que verÃ¡n en listados)"
                            >@form("excerpt").value.getOrElse("")</textarea>
                            <div class="character-indicator" id="excerptIndicator"></div>
                            <div class="help-text">Opcional pero recomendado. Se mostrarÃ¡ en listados y vistas previas. MÃ¡ximo <strong>500 caracteres</strong></div>
                        </div>

                        <div class="form-group">
                            <label for="content">
                                Contenido Principal
                                <span class="required">*</span>
                                <span class="char-count"><span id="contentCount">0</span> caracteres</span>
                            </label>

                            <!-- MARKDOWN TOOLBAR -->
                            <div class="md-toolbar" id="mdToolbar">
                                <div class="md-toolbar-group">
                                    <button type="button" class="md-toolbar-btn" title="Negrita (Ctrl+B)" onclick="insertMd('bold')"><b>B</b></button>
                                    <button type="button" class="md-toolbar-btn" title="Cursiva (Ctrl+I)" onclick="insertMd('italic')"><i>I</i></button>
                                    <button type="button" class="md-toolbar-btn" title="Tachado" onclick="insertMd('strike')"><s>S</s></button>
                                </div>
                                <div class="md-toolbar-group">
                                    <button type="button" class="md-toolbar-btn" title="Encabezado 1" onclick="insertMd('h1')">H1</button>
                                    <button type="button" class="md-toolbar-btn" title="Encabezado 2" onclick="insertMd('h2')">H2</button>
                                    <button type="button" class="md-toolbar-btn" title="Encabezado 3" onclick="insertMd('h3')">H3</button>
                                </div>
                                <div class="md-toolbar-group">
                                    <button type="button" class="md-toolbar-btn" title="Lista" onclick="insertMd('ul')">â˜°</button>
                                    <button type="button" class="md-toolbar-btn" title="Lista Numerada" onclick="insertMd('ol')">1.</button>
                                    <button type="button" class="md-toolbar-btn" title="Cita" onclick="insertMd('quote')">â</button>
                                </div>
                                <div class="md-toolbar-group">
                                    <button type="button" class="md-toolbar-btn" title="CÃ³digo Inline" onclick="insertMd('code')">âŸ¨/âŸ©</button>
                                    <button type="button" class="md-toolbar-btn" title="Bloque de CÃ³digo" onclick="insertMd('codeblock')">{ }</button>
                                    <button type="button" class="md-toolbar-btn" title="Enlace" onclick="insertMd('link')">ğŸ”—</button>
                                    <button type="button" class="md-toolbar-btn" title="Imagen" onclick="insertMd('image')">ğŸ–¼</button>
                                    <button type="button" class="md-toolbar-btn" title="LÃ­nea Horizontal" onclick="insertMd('hr')">â”€</button>
                                    <button type="button" class="md-toolbar-btn" title="Tabla" onclick="insertMd('table')">â–¦</button>
                                </div>
                                <div class="md-toolbar-spacer"></div>
                                <button type="button" class="md-toolbar-toggle" id="previewToggle" onclick="togglePreview()">ğŸ‘ Preview</button>
                                <button type="button" class="md-toolbar-toggle" id="tocToggle" onclick="toggleTOC()">ğŸ“‘ TOC</button>
                                <button type="button" class="md-toolbar-toggle" onclick="openFullscreen()">â›¶ Expandir</button>
                            </div>

                            <!-- EDITOR + PREVIEW SPLIT -->
                            <div class="editor-container" id="editorContainer">
                                <div class="editor-pane">
                                    <textarea
                                        id="content"
                                        name="content"
                                        rows="14"
                                        minlength="50"
                                        required
                                        placeholder="Escribe aquÃ­ el contenido...

# TÃ­tulo de SecciÃ³n

Usa **negrita** y *cursiva*.

```scala
val x = 42
```

- Elemento 1
- Elemento 2"
                                        @if(form("content").hasErrors) { class="has-error" }
                                    >@form("content").value.getOrElse("")</textarea>
                                </div>
                                <div class="preview-pane" id="previewPane">
                                    <div class="preview-empty">Escribe contenido para ver la vista previa...</div>
                                </div>
                            </div>

                            <!-- CONTENT STATS BAR -->
                            <div class="content-stats">
                                <span class="stat-item">ğŸ“ Palabras: <span class="stat-value" id="wordCount">0</span></span>
                                <span class="stat-item">â± Lectura: <span class="stat-value" id="readTime">0 min</span></span>
                                <span class="stat-item">ğŸ“ Caracteres: <span class="stat-value" id="charCount">0</span></span>
                                <span class="stat-item">ğŸ“„ LÃ­neas: <span class="stat-value" id="lineCount">0</span></span>
                            </div>

                            <!-- TABLE OF CONTENTS -->
                            <div class="toc-panel" id="tocPanel">
                                <div class="toc-title">ğŸ“‘ Tabla de Contenidos</div>
                                <ul class="toc-list" id="tocList">
                                    <li class="toc-empty">Agrega encabezados (#, ##, ###) para generar la tabla de contenidos</li>
                                </ul>
                            </div>

                            <div class="character-indicator" id="contentIndicator"></div>
                            <div class="help-text">
                                MÃ­nimo <strong>50 caracteres</strong>. Soporta <strong>Markdown</strong>.
                                <span class="kbd">Ctrl+B</span> Negrita
                                <span class="kbd">Ctrl+I</span> Cursiva
                                <span class="kbd">Ctrl+Shift+F</span> Pantalla completa
                            </div>
                            <div class="content-tip">
                                <strong>ğŸ’¡ Consejo:</strong> Estructura tu contenido con encabezados, pÃ¡rrafos cortos y ejemplos de cÃ³digo.
                                Esto facilita la lectura y mejora el SEO.
                            </div>
                            @if(form("content").hasErrors) {
                                <div class="field-error">@form("content").errors.map(_.message).mkString(", ")</div>
                            }
                        </div>
                    </div>

                    <!-- SECCIÃ“N: IMAGEN Y DETALLES -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <span>ğŸ¨</span>
                            <span>Imagen de Portada y Detalles</span>
                        </div>

                        <div class="form-group">
                            <label for="coverImage">Imagen de Portada (URL)</label>
                            <input
                                type="url"
                                id="coverImage"
                                name="coverImage"
                                value="@form("coverImage").value.getOrElse("")"
                                placeholder="https://ejemplo.com/imagen.jpg"
                            />
                            <div class="help-text">
                                Opcional. Proporciona una URL completa. Recomendaciones:
                                <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                                    <li>TamaÃ±o: <strong>1200x630px</strong> (ratio 16:9)</li>
                                    <li>Formato: JPG o PNG</li>
                                    <li>TamaÃ±o archivo: &lt; 500KB</li>
                                </ul>
                            </div>
                            <!-- IMAGE LIVE PREVIEW -->
                            <div class="image-preview-container" id="imagePreviewContainer">
                                <div class="image-preview-header">
                                    <span>ğŸ–¼ Vista previa de imagen</span>
                                    <span class="image-dimensions" id="imageDimensions"></span>
                                </div>
                                <div class="image-preview-body" id="imagePreviewBody">
                                    <img id="imagePreviewImg" style="display:none;" alt="Preview de portada" />
                                    <span class="image-preview-loading" id="imagePreviewLoading">Cargando imagen...</span>
                                    <span class="image-preview-error" id="imagePreviewError" style="display:none;">âš ï¸ No se pudo cargar la imagen</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ACCIONES -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20" style="display: inline;">
                                <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"/>
                            </svg>
                            @if(publication.isDefined) { ğŸ“¤ Actualizar PublicaciÃ³n } else { ğŸš€ Publicar Contenido }
                        </button>
                        <a href="@routes.UserPublicationController.dashboard()" class="btn btn-secondary">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20" style="display: inline;">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="@routes.Assets.versioned("javascripts/publicationForm.js")"></script>
}

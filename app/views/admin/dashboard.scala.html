@(contacts: Seq[models.ContactRecord], username: String, currentPage: Int, totalPages: Int, searchQuery: Option[String], pendingPublicationsCount: Int, pendingAdminsCount: Int = 0, role: String = "admin")(implicit request: RequestHeader, flash: Flash)

@admin.adminLayout("Dashboard") {
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
            <h2 style="font-size: 1.25rem; font-weight: 700; color: #1a202c; margin-bottom: 0.25rem;">Dashboard</h2>
            <p style="font-size: 0.8125rem; color: #64748b;">Bienvenido, <strong>@username</strong>
                @if(role == "super_admin") {
                    <span style="background: #7c3aed; color: white; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.6875rem; font-weight: 600; margin-left: 0.5rem;">Super Admin</span>
                }
            </p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            @if(role == "super_admin") {
                <a href="@routes.AdminController.adminManagement()" class="btn btn-primary">
                    Gesti√≥n de Admins
                    @if(pendingAdminsCount > 0) {
                        <span style="background: #ef4444; color: white; padding: 0.0625rem 0.375rem; border-radius: 9999px; font-size: 0.6875rem; margin-left: 0.25rem;">@pendingAdminsCount</span>
                    }
                </a>
            }
            <a href="@routes.AdminController.pendingPublications()" class="btn btn-success">
                Publicaciones Pendientes
            </a>
            <a href="@routes.AdminController.createContactPage()" class="btn btn-secondary">
                Nuevo Contacto
            </a>
        </div>
    </div>

    @if(role == "super_admin" && pendingAdminsCount > 0) {
        <div style="background: #f5f0ff; border: 1px solid #ddd6fe; padding: 1.25rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #7c3aed;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="font-size: 1rem; font-weight: 700; color: #1a202c; margin-bottom: 0.25rem;">üõ°Ô∏è Administradores pendientes de aprobaci√≥n</h3>
                    <p style="font-size: 0.8125rem; color: #64748b;">Tienes <strong>@pendingAdminsCount</strong> solicitud(es) de administrador esperando tu aprobaci√≥n</p>
                </div>
                <a href="@routes.AdminController.adminManagement()" class="btn btn-primary" style="white-space: nowrap;">
                    Gestionar
                </a>
            </div>
        </div>
    }

    @if(pendingPublicationsCount > 0) {
        <div style="background: #fff8f0; border: 1px solid #e8ddd0; padding: 1.25rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #8a7035;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="font-size: 1rem; font-weight: 700; color: #1a202c; margin-bottom: 0.25rem;">Publicaciones pendientes de revisi√≥n</h3>
                    <p style="font-size: 0.8125rem; color: #64748b;">Tienes <strong>@pendingPublicationsCount</strong> publicaci√≥n(es) esperando aprobaci√≥n</p>
                </div>
                <a href="@routes.AdminController.pendingPublications()" class="btn btn-warning" style="white-space: nowrap;">
                    Revisar ahora
                </a>
            </div>
        </div>
    }

    @defining({
        val allContacts = contacts
        val total = allContacts.length
        val pending = allContacts.count(_.status == "pending")
        val processed = allContacts.count(_.status == "processed")
        val archived = allContacts.count(_.status == "archived")
        (total, pending, processed, archived)
    }) { case (total, pending, processed, archived) =>
        <!-- Tarjetas de Estad√≠sticas de Contactos -->
        <h3 style="font-size: 0.8125rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem;">Estad√≠sticas de Contactos</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="card" style="border-left: 3px solid #94a3b8; padding: 1.25rem;">
                <div style="font-size: 0.6875rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Total</div>
                <div style="font-size: 2rem; font-weight: 700; color: #1a202c; margin-top: 0.25rem;">@total</div>
            </div>
            
            <div class="card" style="border-left: 3px solid #d4a853; padding: 1.25rem;">
                <div style="font-size: 0.6875rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Pendientes</div>
                <div style="font-size: 2rem; font-weight: 700; color: #1a202c; margin-top: 0.25rem;">@pending</div>
            </div>
            
            <div class="card" style="border-left: 3px solid #6b8f71; padding: 1.25rem;">
                <div style="font-size: 0.6875rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Procesados</div>
                <div style="font-size: 2rem; font-weight: 700; color: #1a202c; margin-top: 0.25rem;">@processed</div>
            </div>
            
            <div class="card" style="border-left: 3px solid #8b9fad; padding: 1.25rem;">
                <div style="font-size: 0.6875rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Archivados</div>
                <div style="font-size: 2rem; font-weight: 700; color: #1a202c; margin-top: 0.25rem;">@archived</div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="card">
                <h3 style="font-size: 0.8125rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem;">Distribuci√≥n por Estado</h3>
                <canvas id="statusChart" style="max-height: 300px;"></canvas>
            </div>
            
            <div class="card">
                <h3 style="font-size: 0.8125rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem;">Resumen General</h3>
                <canvas id="summaryChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <div class="card" style="margin-bottom: 1.5rem;">
            <h3 style="font-size: 0.8125rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem;">Actividad Temporal</h3>
            <canvas id="timelineChart" style="max-height: 250px;"></canvas>
        </div>
    }
    
    <div class="card">
        <div class="search-bar" style="margin-bottom: 1.5rem;">
            <form method="GET" action="@routes.AdminController.dashboard(0, None)" style="display: flex; gap: 1rem;">
                <input 
                    type="text" 
                    name="search" 
                    placeholder="Buscar por nombre, email o mensaje..." 
                    value="@searchQuery.getOrElse("")"
                    style="flex: 1;"
                />
                <button type="submit" class="btn btn-primary">Buscar</button>
                @if(searchQuery.isDefined) {
                    <a href="@routes.AdminController.dashboard(0, None)" class="btn btn-secondary">Limpiar</a>
                }
            </form>
        </div>
        
        @if(contacts.isEmpty) {
            <div style="text-align: center; padding: 3rem; color: #64748b;">
                <p style="font-size: 0.875rem;">No hay contactos registrados</p>
            </div>
        } else {
            <div class="table-responsive" style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Mensaje</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th style="text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for(contact <- contacts) {
                            <tr>
                                <td>@contact.id.getOrElse("-")</td>
                                <td style="font-weight: 500;">@contact.name</td>
                                <td>@contact.email</td>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    @contact.message.take(50)@if(contact.message.length > 50) { ... }
                                </td>
                                <td>
                                    <span class="badge @{contact.status match { case "pending" => "badge-pending"; case "processed" => "badge-processed"; case "archived" => "badge-archived"; case _ => "badge-draft" }}">
                                        @contact.status match {
                                            case "pending" => { Pendiente }
                                            case "processed" => { Procesado }
                                            case "archived" => { Archivado }
                                            case _ => { @contact.status }
                                        }
                                    </span>
                                </td>
                                <td style="font-size: 0.8125rem; color: #64748b;">
                                    @{
                                        val formatter = java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm")
                                        contact.createdAt.atZone(java.time.ZoneId.systemDefault()).format(formatter)
                                    }
                                </td>
                                <td style="text-align: center;">
                                    <div style="display: flex; gap: 0.375rem; justify-content: center;">
                                        <a href="@routes.AdminController.viewContact(contact.id.get)" class="btn btn-secondary btn-sm">Ver</a>
                                        <a href="@routes.AdminController.editContactPage(contact.id.get)" class="btn btn-primary btn-sm">Editar</a>
                                        <form method="POST" 
                                              action="@routes.AdminController.deleteContact(contact.id.get)" 
                                              style="display: inline;"
                                              onsubmit="return confirm('¬øEst√°s seguro de eliminar este contacto?');">
                                            @helper.CSRF.formField
                                            <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            @if(totalPages > 1) {
                <div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem;">
                    @if(currentPage > 0) {
                        <a href="@routes.AdminController.dashboard(currentPage - 1, searchQuery)" class="btn btn-secondary">
                            ‚Üê Anterior
                        </a>
                    }
                    
                    <span style="padding: 0.5rem 1rem; color: #64748b; font-size: 0.8125rem;">
                        P√°gina @{currentPage + 1} de @totalPages
                    </span>
                    
                    @if(currentPage < totalPages - 1) {
                        <a href="@routes.AdminController.dashboard(currentPage + 1, searchQuery)" class="btn btn-secondary">
                            Siguiente ‚Üí
                        </a>
                    }
                </div>
            }
        }
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@@4.4.1/dist/chart.umd.js"></script>

    <!-- Datos del servidor inyectados como JSON (evita warnings del IDE) -->
    <div id="chartData" style="display:none"
         data-pending="@{contacts.count(_.status == "pending")}"
         data-processed="@{contacts.count(_.status == "processed")}"
         data-archived="@{contacts.count(_.status == "archived")}"
         data-total="@{contacts.length}">
    </div>
    <script id="contactsJson" type="application/json">@Html(play.api.libs.json.Json.toJson(contacts.map(c => play.api.libs.json.Json.obj("createdAt" -> c.createdAt.toString(), "status" -> c.status))).toString())</script>

    <script>
        const dataEl = document.getElementById('chartData');
        const pending = parseInt(dataEl.dataset.pending);
        const processed = parseInt(dataEl.dataset.processed);
        const archived = parseInt(dataEl.dataset.archived);
        const total = parseInt(dataEl.dataset.total);

        const allContacts = JSON.parse(document.getElementById('contactsJson').textContent);
        
        const now = new Date();
        const today = allContacts.filter(c => {
            const cDate = new Date(c.createdAt);
            return cDate.toDateString() === now.toDateString();
        }).length;
        
        const thisWeek = allContacts.filter(c => {
            const cDate = new Date(c.createdAt);
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            return cDate >= weekAgo;
        }).length;
        
        const thisMonth = allContacts.filter(c => {
            const cDate = new Date(c.createdAt);
            return cDate.getMonth() === now.getMonth() && cDate.getFullYear() === now.getFullYear();
        }).length;

        // Colores del tema (paleta neutra)
        const colors = {
            pending: '#d4a853',
            processed: '#6b8f71',
            archived: '#8b9fad',
            primary: '#64748b'
        };

        // Configuraci√≥n com√∫n
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                }
            }
        };

        // 1. Gr√°fico de Pastel - Estados
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Pendientes', 'Procesados', 'Archivados'],
                datasets: [{
                    data: [pending, processed, archived],
                    backgroundColor: [
                        colors.pending,
                        colors.processed,
                        colors.archived
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                ...chartConfig,
                cutout: '60%',
                plugins: {
                    ...chartConfig.plugins,
                    legend: {
                        ...chartConfig.plugins.legend,
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    }
                }
            }
        });

        // 2. Gr√°fico de Barras - Resumen
        const summaryCtx = document.getElementById('summaryChart').getContext('2d');
        new Chart(summaryCtx, {
            type: 'bar',
            data: {
                labels: ['Pendientes', 'Procesados', 'Archivados'],
                datasets: [{
                    label: 'Cantidad',
                    data: [pending, processed, archived],
                    backgroundColor: [
                        colors.pending,
                        colors.processed,
                        colors.archived
                    ],
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    ...chartConfig.plugins,
                    legend: {
                        display: false
                    }
                }
            }
        });

        // 3. Gr√°fico de L√≠nea - Tendencia Temporal
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: ['Hoy', 'Esta Semana', 'Este Mes', 'Total'],
                datasets: [{
                    label: 'Contactos',
                    data: [today, thisWeek, thisMonth, total],
                    borderColor: colors.primary,
                    backgroundColor: colors.primary + '20',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: colors.primary,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    ...chartConfig.plugins,
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Contactos: ' + context.parsed.y;
                            }
                        }
                    }
                }
            }
        });

        console.log('üìä Gr√°ficos cargados exitosamente');
        console.log('Total:', total, '| Pendientes:', pending, '| Procesados:', processed, '| Archivados:', archived);
    </script>
}

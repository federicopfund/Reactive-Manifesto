@(dynamicPublications: List[models.PublicationWithAuthor], searchQuery: String = "", searchCategory: Option[String] = None)(implicit request: RequestHeader, messages: Messages)

@main("Publicaciones del clan") {
    <!-- Hero + Unified Search -->
    <section class="hero hero-secondary">
        <div class="container">
            <div class="hero-content">
                <h2 class="hero-title">Publicaciones del clan</h2>
                <p class="hero-subtitle">Art√≠culos, tutoriales y recursos sobre programaci√≥n reactiva</p>
            </div>
            <!-- Search bar integrated into hero -->
            <div class="pub-search-bar">
                <form action="@routes.HomeController.searchPublicaciones()" method="GET" class="pub-search-form" id="pubSearchForm">
                    <div class="pub-search-field">
                        <svg class="pub-search-icon" viewBox="0 0 20 20" fill="currentColor" width="18" height="18">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        <input type="text" name="q" value="@searchQuery" placeholder="Buscar por t√≠tulo, contenido o tags..." class="pub-search-input" id="pubSearchInput" autocomplete="off">
                        @if(searchQuery.nonEmpty) {
                            <a href="@routes.HomeController.publicaciones()" class="pub-search-clear" title="Limpiar b√∫squeda">&times;</a>
                        }
                    </div>
                    <div class="pub-search-actions">
                        <select name="category" class="pub-search-select" id="pubCategorySelect">
                            <option value="">Todas</option>
                            <option value="Tutorial" @if(searchCategory.contains("Tutorial")){selected}>Tutorial</option>
                            <option value="Art√≠culo" @if(searchCategory.contains("Art√≠culo")){selected}>Art√≠culo</option>
                            <option value="Gu√≠a" @if(searchCategory.contains("Gu√≠a")){selected}>Gu√≠a</option>
                            <option value="Caso de Estudio" @if(searchCategory.contains("Caso de Estudio")){selected}>Caso de Estudio</option>
                            <option value="Recurso" @if(searchCategory.contains("Recurso")){selected}>Recurso</option>
                        </select>
                        <button type="submit" class="pub-search-btn">
                            <svg viewBox="0 0 20 20" fill="currentColor" width="16" height="16">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                            </svg>
                            Buscar
                        </button>
                    </div>
                </form>
                @if(searchQuery.nonEmpty) {
                    <p class="pub-search-results-info">
                        @{dynamicPublications.size + 6} resultados para "<strong>@searchQuery</strong>"
                        @searchCategory.map { cat => en <strong>@cat</strong> }
                    </p>
                }
            </div>
        </div>
    </section>

    <!-- Category pills (quick filters) -->
    <nav class="pub-category-nav">
        <div class="container">
            <div class="pub-category-pills" id="pubCategoryPills">
                <button class="pub-pill active" data-category="all">Todas</button>
                <button class="pub-pill" data-category="Tutorial">Tutorial</button>
                <button class="pub-pill" data-category="Art√≠culo">Art√≠culo</button>
                <button class="pub-pill" data-category="Gu√≠a">Gu√≠a</button>
                <button class="pub-pill" data-category="Caso de Estudio">Caso de Estudio</button>
                <button class="pub-pill" data-category="Recurso">Recurso</button>
            </div>
            <div class="pub-results-count" id="pubResultsCount"></div>
        </div>
    </nav>

    <!-- Publications Grid -->
    <section class="publications-section">
        <div class="container">
            <div class="publications-grid">
                <!-- Publication 1 -->
                <article class="publication-card pub-filterable" data-category="Tutorial" data-searchable="introducci√≥n akka actors actores concurrentes resilientes modelo">
                    <div class="publication-header">
                        <span class="publication-category">Tutorial</span>
                        <span class="publication-date">15 Dic 2025</span>
                    </div>
                    <h3 class="publication-title">Introducci√≥n a Akka Actors</h3>
                    <p class="publication-excerpt">
                        Aprende los fundamentos de los actores en Akka y c√≥mo implementar 
                        sistemas concurrentes y resilientes usando el modelo de actores.
                    </p>
                    <div class="publication-tags">
                        <span class="tag">Akka</span>
                        <span class="tag">Scala</span>
                        <span class="tag">Concurrencia</span>
                    </div>
                    <a href="@routes.HomeController.publicacion("akka-actors")" class="publication-link">Leer m√°s</a>
                </article>

                <!-- Publication 2 -->
                <article class="publication-card pub-filterable" data-category="Art√≠culo" data-searchable="patrones resiliencia circuit breakers bulkheads recuperaci√≥n arquitectura">
                    <div class="publication-header">
                        <span class="publication-category">Art√≠culo</span>
                        <span class="publication-date">8 Dic 2025</span>
                    </div>
                    <h3 class="publication-title">Patrones de Resiliencia</h3>
                    <p class="publication-excerpt">
                        Explora patrones avanzados para construir sistemas resilientes: 
                        circuit breakers, bulkheads, y estrategias de recuperaci√≥n.
                    </p>
                    <div class="publication-tags">
                        <span class="tag">Patrones</span>
                        <span class="tag">Resiliencia</span>
                        <span class="tag">Arquitectura</span>
                    </div>
                    <a href="@routes.HomeController.publicacion("patrones-resiliencia")" class="publication-link">Leer m√°s</a>
                </article>

                <!-- Publication 3 -->
                <article class="publication-card pub-filterable" data-category="Gu√≠a" data-searchable="streams reactivos akka streams backpressure procesamiento as√≠ncrono flujos">
                    <div class="publication-header">
                        <span class="publication-category">Gu√≠a</span>
                        <span class="publication-date">1 Dic 2025</span>
                    </div>
                    <h3 class="publication-title">Streams Reactivos con Akka Streams</h3>
                    <p class="publication-excerpt">
                        Una gu√≠a completa para trabajar con flujos de datos reactivos, 
                        backpressure y procesamiento as√≠ncrono eficiente.
                    </p>
                    <div class="publication-tags">
                        <span class="tag">Akka Streams</span>
                        <span class="tag">Reactive Streams</span>
                        <span class="tag">Backpressure</span>
                    </div>
                    <a href="@routes.HomeController.publicacion("akka-streams")" class="publication-link">Leer m√°s</a>
                </article>

                <!-- Publication 4 -->
                <article class="publication-card pub-filterable" data-category="Tutorial" data-searchable="play framework programaci√≥n as√≠ncrona web alto rendimiento">
                    <div class="publication-header">
                        <span class="publication-category">Tutorial</span>
                        <span class="publication-date">25 Nov 2025</span>
                    </div>
                    <h3 class="publication-title">Play Framework y Programaci√≥n As√≠ncrona</h3>
                    <p class="publication-excerpt">
                        Descubre c√≥mo Play Framework aprovecha la programaci√≥n as√≠ncrona 
                        para construir aplicaciones web de alto rendimiento.
                    </p>
                    <div class="publication-tags">
                        <span class="tag">Play Framework</span>
                        <span class="tag">Async</span>
                        <span class="tag">Web</span>
                    </div>
                    <a href="@routes.HomeController.publicacion("play-async")" class="publication-link">Leer m√°s</a>
                </article>

                <!-- Publication 5 -->
                <article class="publication-card pub-filterable" data-category="Caso de Estudio" data-searchable="escalabilidad message passing mensajer√≠a distribuci√≥n sistemas distribuidos">
                    <div class="publication-header">
                        <span class="publication-category">Caso de Estudio</span>
                        <span class="publication-date">18 Nov 2025</span>
                    </div>
                    <h3 class="publication-title">Escalabilidad con Message Passing</h3>
                    <p class="publication-excerpt">
                        C√≥mo implementar sistemas distribuidos escalables utilizando 
                        patrones de mensajer√≠a y comunicaci√≥n as√≠ncrona.
                    </p>
                    <div class="publication-tags">
                        <span class="tag">Mensajer√≠a</span>
                        <span class="tag">Distribuci√≥n</span>
                        <span class="tag">Escalabilidad</span>
                    </div>
                    <a href="@routes.HomeController.publicacion("message-passing")" class="publication-link">Leer m√°s</a>
                </article>

                <!-- Publication 6 -->
                <article class="publication-card pub-filterable" data-category="Recurso" data-searchable="testing sistemas reactivos testkit property-based qa">
                    <div class="publication-header">
                        <span class="publication-category">Recurso</span>
                        <span class="publication-date">10 Nov 2025</span>
                    </div>
                    <h3 class="publication-title">Testing de Sistemas Reactivos</h3>
                    <p class="publication-excerpt">
                        Estrategias y herramientas para testear aplicaciones reactivas: 
                        TestKit, Property-based testing, y m√°s.
                    </p>
                    <div class="publication-tags">
                        <span class="tag">Testing</span>
                        <span class="tag">Akka TestKit</span>
                        <span class="tag">QA</span>
                    </div>
                    <a href="@routes.HomeController.publicacion("testing-reactivo")" class="publication-link">Leer m√°s</a>
                </article>
            </div>

            <!-- Publicaciones de la Comunidad -->
            @if(dynamicPublications.nonEmpty) {
                <div class="community-publications-section">
                    <h2 class="section-title">üìö Publicaciones de la Comunidad</h2>
                    <p class="section-subtitle">Contenido creado y compartido por nuestra comunidad de desarrolladores</p>
                    
                    <div class="publications-grid">
                        @for(pubWithAuthor <- dynamicPublications) {
                            <article class="publication-card publication-community pub-filterable" data-category="@pubWithAuthor.publication.category" data-searchable="@pubWithAuthor.publication.title.toLowerCase @pubWithAuthor.publication.excerpt.getOrElse("") @pubWithAuthor.publication.tags.getOrElse("") @pubWithAuthor.authorUsername">
                                <div class="publication-header">
                                    <span class="publication-category">@pubWithAuthor.publication.category</span>
                                    <span class="publication-date">@{
                                        val formatter = java.time.format.DateTimeFormatter.ofPattern("dd MMM yyyy")
                                        pubWithAuthor.publication.publishedAt
                                          .getOrElse(pubWithAuthor.publication.createdAt)
                                          .atZone(java.time.ZoneId.systemDefault())
                                          .format(formatter)
                                    }</span>
                                </div>
                                <h3 class="publication-title">@pubWithAuthor.publication.title</h3>
                                <p class="publication-excerpt">
                                    @pubWithAuthor.publication.excerpt.getOrElse(pubWithAuthor.publication.content.take(200) + "...")
                                </p>
                                <div class="publication-meta">
                                    <span class="publication-author">üë§ @pubWithAuthor.authorUsername</span>
                                    <span class="publication-views">üëÅÔ∏è @pubWithAuthor.publication.viewCount vistas</span>
                                    <span class="publication-views">‚è±Ô∏è ~@{Math.max(1, pubWithAuthor.publication.content.split("\\s+").length / 200)} min</span>
                                </div>
                                @if(pubWithAuthor.publication.tags.isDefined) {
                                    <div class="publication-tags">
                                        @for(tag <- pubWithAuthor.publication.tags.get.split(",").take(3)) {
                                            <span class="tag">@tag.trim</span>
                                        }
                                    </div>
                                }
                                <a href="@routes.HomeController.publicacion(pubWithAuthor.publication.slug)" class="publication-link">Leer m√°s</a>
                            </article>
                        }
                    </div>
                </div>
            }
        </div>
    </section>

    <!-- Newsletter Section -->
    <section class="newsletter-section">
        <div class="container">
            <div class="newsletter-content">
                <h2 class="section-title">Suscr√≠bete a Nuestro Newsletter</h2>
                <p class="section-subtitle">Recibe las √∫ltimas publicaciones y recursos directamente en tu correo</p>
                @request.flash.get("success").map { msg =>
                    <div class="newsletter-alert newsletter-alert-success">@msg</div>
                }
                @request.flash.get("info").map { msg =>
                    <div class="newsletter-alert newsletter-alert-info">@msg</div>
                }
                @request.flash.get("error").map { msg =>
                    <div class="newsletter-alert newsletter-alert-error">@msg</div>
                }
                <form class="newsletter-form" action="@routes.HomeController.subscribeNewsletter()" method="POST">
                    @views.html.helper.CSRF.formField
                    <input type="email" name="email" placeholder="Tu email" class="newsletter-input" required>
                    <button type="submit" class="btn btn-primary">Suscribirse</button>
                </form>
            </div>
        </div>
    </section>

    <script>
    (function() {
        var pills = document.querySelectorAll('.pub-pill');
        var cards = document.querySelectorAll('.pub-filterable');
        var input = document.getElementById('pubSearchInput');
        var counter = document.getElementById('pubResultsCount');
        var categorySelect = document.getElementById('pubCategorySelect');
        var activeCategory = 'all';

        function normalize(s) {
            var diacritics = new RegExp('[' + String.fromCharCode(0x0300) + '-' + String.fromCharCode(0x036f) + ']', 'g');
            return (s || '').toLowerCase().normalize('NFD').replace(diacritics, '');
        }

        function filterCards() {
            var q = normalize(input ? input.value : '');
            var visible = 0;
            cards.forEach(function(card) {
                var cat = card.getAttribute('data-category') || '';
                var text = normalize(
                    (card.getAttribute('data-searchable') || '') + ' ' +
                    card.textContent
                );
                var catMatch = activeCategory === 'all' || cat === activeCategory;
                var textMatch = !q || text.indexOf(q) !== -1;
                if (catMatch && textMatch) {
                    card.style.display = '';
                    visible++;
                } else {
                    card.style.display = 'none';
                }
            });
            if (counter) {
                counter.textContent = visible + ' publicacion' + (visible !== 1 ? 'es' : '');
            }
        }

        pills.forEach(function(pill) {
            pill.addEventListener('click', function(e) {
                e.preventDefault();
                pills.forEach(function(p) { p.classList.remove('active'); });
                pill.classList.add('active');
                activeCategory = pill.getAttribute('data-category');
                // Sync the select dropdown
                if (categorySelect) {
                    categorySelect.value = activeCategory === 'all' ? '' : activeCategory;
                }
                filterCards();
            });
        });

        // Select dropdown triggers client-side filtering instead of form submit
        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                activeCategory = this.value || 'all';
                // Sync the pills
                pills.forEach(function(p) {
                    var pillCat = p.getAttribute('data-category');
                    if (pillCat === activeCategory) {
                        p.classList.add('active');
                    } else {
                        p.classList.remove('active');
                    }
                });
                filterCards();
            });
        }

        if (input) {
            var debounce;
            input.addEventListener('input', function() {
                clearTimeout(debounce);
                debounce = setTimeout(filterCards, 150);
            });
        }

        filterCards();

        // ‚îÄ‚îÄ Hide filter bar on scroll down, show on scroll up ‚îÄ‚îÄ
        // The bar stays visible (sticky) while the user is near the top
        // of the publications section. Once the user scrolls well past the
        // first row of cards it slides away smoothly; scrolling back up
        // always brings it back immediately.
        var nav = document.querySelector('.pub-category-nav');
        var pubSection = document.querySelector('.publications-section');
        if (nav && pubSection) {
            var lastY = window.scrollY;
            var ticking = false;

            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(function() {
                        var currentY = window.scrollY;
                        // Distance from the top of the publications grid
                        var sectionTop = pubSection.getBoundingClientRect().top + window.scrollY;
                        // Hide once the user enters the publications grid
                        var hidePoint = sectionTop + 80;

                        if (currentY > hidePoint && currentY > lastY) {
                            nav.classList.add('nav-hidden');
                        } else {
                            nav.classList.remove('nav-hidden');
                        }
                        lastY = currentY;
                        ticking = false;
                    });
                    ticking = true;
                }
            }, { passive: true });
        }
    })();
    </script>
}
